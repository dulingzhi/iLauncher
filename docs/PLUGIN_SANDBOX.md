# æ’ä»¶æ²™ç›’éš”ç¦»ç³»ç»Ÿ

## æ¦‚è¿°

iLauncher æ’ä»¶æ²™ç›’éš”ç¦»ç³»ç»Ÿæä¾›äº†å®Œå–„çš„æ’ä»¶å®‰å…¨ç®¡ç†æœºåˆ¶ï¼Œé€šè¿‡æƒé™ç®¡ç†å’Œèµ„æºè®¿é—®æ§åˆ¶ï¼Œä¿æŠ¤ç”¨æˆ·ç³»ç»Ÿå…å—æ¶æ„æ’ä»¶æ”»å‡»ã€‚

## æ ¸å¿ƒåŠŸèƒ½

### 1. å®‰å…¨çº§åˆ«

æ’ä»¶ç³»ç»Ÿå®šä¹‰äº†å››ä¸ªå®‰å…¨çº§åˆ«ï¼š

#### ç³»ç»Ÿçº§ (System)
- **æƒé™**ï¼šå®Œå…¨ä¿¡ä»»ï¼Œæ— ä»»ä½•é™åˆ¶
- **é€‚ç”¨åœºæ™¯**ï¼šå†…ç½®æ’ä»¶ï¼ˆå¦‚æ–‡ä»¶æœç´¢ã€åº”ç”¨æœç´¢ã€è®¡ç®—å™¨ç­‰ï¼‰
- **æ²™ç›’çŠ¶æ€**ï¼šç¦ç”¨
- **å›¾æ ‡**ï¼šğŸ›¡ï¸ ç»¿è‰²ç›¾ç‰Œ

#### ä¿¡ä»»çº§ (Trusted)
- **æƒé™**ï¼šç»è¿‡éªŒè¯çš„ç¬¬ä¸‰æ–¹æ’ä»¶ï¼Œæ‹¥æœ‰è¾ƒå¤šæƒé™
- **å…è®¸æ“ä½œ**ï¼š
  - æ–‡ä»¶ç³»ç»Ÿè¯»å–ï¼ˆå…¨éƒ¨ï¼‰
  - ç½‘ç»œè®¿é—®ï¼ˆå…¨éƒ¨ï¼‰
  - å‰ªè´´æ¿è®¿é—®
  - ç³»ç»Ÿä¿¡æ¯è¯»å–
  - æ‰§è¡Œå¤–éƒ¨ç¨‹åº
- **é€‚ç”¨åœºæ™¯**ï¼šç»è¿‡å®˜æ–¹å®¡æ ¸æˆ–ç¤¾åŒºè®¤è¯çš„æ’ä»¶
- **å›¾æ ‡**ï¼šâœ… è“è‰²å‹¾é€‰

#### å—é™çº§ (Restricted) - **é»˜è®¤**
- **æƒé™**ï¼šæœ€å°æƒé™é›†
- **å…è®¸æ“ä½œ**ï¼š
  - ç³»ç»Ÿä¿¡æ¯è¯»å–
  - å‰ªè´´æ¿è®¿é—®
- **é€‚ç”¨åœºæ™¯**ï¼šæœªç»éªŒè¯çš„ç¬¬ä¸‰æ–¹æ’ä»¶
- **è¶…æ—¶é™åˆ¶**ï¼š5 ç§’
- **å†…å­˜é™åˆ¶**ï¼š100 MB
- **å›¾æ ‡**ï¼šâš ï¸ é»„è‰²è­¦å‘Š

#### æ²™ç›’çº§ (Sandboxed)
- **æƒé™**ï¼šæåº¦å—é™
- **å…è®¸æ“ä½œ**ï¼š
  - ä»…ç³»ç»Ÿä¿¡æ¯è¯»å–
- **é€‚ç”¨åœºæ™¯**ï¼šä¸ä¿¡ä»»çš„æ’ä»¶
- **å›¾æ ‡**ï¼šğŸ”’ çº¢è‰²é”

### 2. æƒé™ç³»ç»Ÿ

æ‰€æœ‰æƒé™ç±»å‹ï¼š

```rust
pub enum PluginPermission {
    FileSystemRead(PathBuf),       // æ–‡ä»¶è¯»å–
    FileSystemWrite(PathBuf),      // æ–‡ä»¶å†™å…¥
    NetworkAccess(NetworkScope),   // ç½‘ç»œè®¿é—®
    ExecuteProgram,                // ç¨‹åºæ‰§è¡Œ
    ClipboardAccess,               // å‰ªè´´æ¿
    SystemInfoRead,                // ç³»ç»Ÿä¿¡æ¯
    ProcessManagement,             // è¿›ç¨‹ç®¡ç†
    WindowManagement,              // çª—å£ç®¡ç†
    RegistryAccess,                // æ³¨å†Œè¡¨ (Windows)
    EnvironmentAccess,             // ç¯å¢ƒå˜é‡
}
```

### 3. èµ„æºè®¿é—®æ§åˆ¶

#### æ–‡ä»¶ç³»ç»Ÿ

```rust
// æ£€æŸ¥æ–‡ä»¶è¯»å–æƒé™
sandbox_manager.validate_file_access(plugin_id, path, false)?;

// æ£€æŸ¥æ–‡ä»¶å†™å…¥æƒé™
sandbox_manager.validate_file_access(plugin_id, path, true)?;
```

#### ç½‘ç»œè®¿é—®

```rust
// æ£€æŸ¥åŸŸåè®¿é—®æƒé™
sandbox_manager.validate_network_access(plugin_id, "api.example.com")?;
```

#### ç¨‹åºæ‰§è¡Œ

```rust
// æ£€æŸ¥ç¨‹åºæ‰§è¡Œæƒé™
sandbox_manager.validate_program_execution(plugin_id)?;
```

### 4. æ‰§è¡Œç¯å¢ƒéš”ç¦»

```rust
// åˆ›å»ºæ²™ç›’æ‰§è¡Œç¯å¢ƒ
let executor = SandboxedExecution::<Result>::new(
    plugin_id.to_string(),
    Arc::clone(&sandbox_manager),
);

// åœ¨æ²™ç›’ä¸­æ‰§è¡Œå‡½æ•°ï¼ˆè‡ªåŠ¨åº”ç”¨è¶…æ—¶é™åˆ¶ï¼‰
let result = executor.execute(|| async {
    // æ’ä»¶ä»£ç 
    Ok(data)
}).await?;
```

## ä½¿ç”¨æŒ‡å—

### æ’ä»¶å¼€å‘è€…

#### 1. å£°æ˜æ‰€éœ€æƒé™

åœ¨æ’ä»¶å…ƒæ•°æ®ä¸­å£°æ˜ï¼š

```rust
// ç¤ºä¾‹ï¼šéœ€è¦ç½‘ç»œå’Œæ–‡ä»¶è¯»å–æƒé™çš„æ’ä»¶
impl Plugin for MyPlugin {
    fn metadata(&self) -> &PluginMetadata {
        // åœ¨æ’ä»¶æ–‡æ¡£ä¸­è¯´æ˜éœ€è¦çš„æƒé™
    }
    
    async fn query(&self, ctx: &QueryContext) -> Result<Vec<QueryResult>> {
        // åœ¨æ‰§è¡Œå‰æ£€æŸ¥æƒé™
        self.sandbox_manager.check_permission(
            &self.metadata.id,
            &PluginPermission::NetworkAccess(NetworkScope::All),
        )?;
        
        // æ‰§è¡ŒæŸ¥è¯¢
        Ok(results)
    }
}
```

#### 2. ä½¿ç”¨æ²™ç›’æ¼”ç¤ºæ’ä»¶å­¦ä¹ 

æŸ¥çœ‹ `src-tauri/src/plugin/sandbox_demo.rs` ä¸­çš„å®Œæ•´ç¤ºä¾‹ã€‚

### ç”¨æˆ·

#### 1. æŸ¥çœ‹æ’ä»¶æƒé™

åœ¨æ’ä»¶ç®¡ç†å™¨ä¸­ï¼š
1. ç‚¹å‡»æ’ä»¶å³ä¾§çš„"é…ç½®"æŒ‰é’®
2. åˆ‡æ¢åˆ°"æ²™ç›’éš”ç¦»"æ ‡ç­¾é¡µ
3. æŸ¥çœ‹å½“å‰æƒé™åˆ—è¡¨

#### 2. è°ƒæ•´å®‰å…¨çº§åˆ«

1. åœ¨æ²™ç›’éš”ç¦»æ ‡ç­¾é¡µä¸­é€‰æ‹©å®‰å…¨çº§åˆ«
2. ç³»ç»Ÿçº§æ’ä»¶æ— æ³•è°ƒæ•´ï¼ˆç°è‰²æ˜¾ç¤ºï¼‰
3. ç¬¬ä¸‰æ–¹æ’ä»¶å¯åœ¨å››ä¸ªçº§åˆ«ä¸­é€‰æ‹©

#### 3. å¯ç”¨/ç¦ç”¨æ²™ç›’

- ç‚¹å‡»å³ä¸Šè§’çš„"å·²å¯ç”¨"/"å·²ç¦ç”¨"å¼€å…³
- ç³»ç»Ÿçº§æ’ä»¶é»˜è®¤ç¦ç”¨æ²™ç›’

## API å‚è€ƒ

### Tauri å‘½ä»¤

```typescript
// è·å–æ’ä»¶æ²™ç›’é…ç½®
await invoke<SandboxConfig>('get_sandbox_config', { pluginId });

// æ›´æ–°æ’ä»¶æ²™ç›’é…ç½®
await invoke('update_sandbox_config', { config });

// è·å–æ’ä»¶æƒé™åˆ—è¡¨
await invoke<string[]>('get_plugin_permissions', { pluginId });

// æ£€æŸ¥æ’ä»¶æƒé™
await invoke<boolean>('check_plugin_permission', {
  pluginId,
  permission,
});
```

### Rust API

```rust
// æ³¨å†Œæ²™ç›’é…ç½®
sandbox_manager.register(SandboxConfig::restricted("my_plugin"));

// æ£€æŸ¥æƒé™
sandbox_manager.check_permission(
    "my_plugin",
    &PluginPermission::FileSystemRead(PathBuf::from("/path")),
)?;

// éªŒè¯æ–‡ä»¶è®¿é—®
sandbox_manager.validate_file_access("my_plugin", path, false)?;

// åœ¨æ²™ç›’ä¸­æ‰§è¡Œ
let executor = SandboxedExecution::new(plugin_id, manager);
executor.execute(|| async { /* code */ }).await?;
```

## å®‰å…¨æœ€ä½³å®è·µ

### å¼€å‘è€…

1. **æœ€å°æƒé™åŸåˆ™**ï¼šåªè¯·æ±‚å¿…éœ€çš„æƒé™
2. **æƒé™æ£€æŸ¥**ï¼šåœ¨æ‰§è¡Œæ•æ„Ÿæ“ä½œå‰ä¸»åŠ¨æ£€æŸ¥æƒé™
3. **é”™è¯¯å¤„ç†**ï¼šä¼˜é›…å¤„ç†æƒé™æ‹’ç»é”™è¯¯
4. **æ–‡æ¡£è¯´æ˜**ï¼šåœ¨æ’ä»¶æ–‡æ¡£ä¸­æ˜ç¡®è¯´æ˜æ‰€éœ€æƒé™

### ç”¨æˆ·

1. **é»˜è®¤å—é™**ï¼šç¬¬ä¸‰æ–¹æ’ä»¶é»˜è®¤ä½¿ç”¨å—é™çº§
2. **è°¨æ…æˆæƒ**ï¼šåªä¸ºä¿¡ä»»çš„æ’ä»¶æå‡å®‰å…¨çº§åˆ«
3. **å®šæœŸæ£€æŸ¥**ï¼šå®šæœŸå®¡æŸ¥æ’ä»¶æƒé™é…ç½®
4. **åŠæ—¶æ›´æ–°**ï¼šä¿æŒæ’ä»¶å’Œåº”ç”¨ç¨‹åºæœ€æ–°

## ç¤ºä¾‹åœºæ™¯

### åœºæ™¯ 1ï¼šå®‰å…¨çš„è®¡ç®—å™¨æ’ä»¶

```rust
// ç³»ç»Ÿçº§ï¼Œæ— éœ€ä»»ä½•æƒé™
SandboxConfig::system("calculator")
```

### åœºæ™¯ 2ï¼šéœ€è¦ç½‘ç»œçš„ç¿»è¯‘æ’ä»¶

```rust
// å—é™çº§ï¼Œæ·»åŠ ç½‘ç»œæƒé™
SandboxConfig::restricted("translator")
    .with_permission(PluginPermission::NetworkAccess(
        NetworkScope::Domain("translate.googleapis.com".to_string())
    ))
```

### åœºæ™¯ 3ï¼šæ–‡ä»¶æœç´¢æ’ä»¶

```rust
// ç³»ç»Ÿçº§ï¼ˆå†…ç½®ï¼‰ï¼Œéœ€è¦å®Œæ•´æ–‡ä»¶ç³»ç»Ÿè®¿é—®
SandboxConfig::system("file_search")
```

## æ•…éšœæ’æŸ¥

### é—®é¢˜ï¼šæ’ä»¶åŠŸèƒ½å¼‚å¸¸

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥æ’ä»¶æ˜¯å¦æœ‰è¶³å¤Ÿæƒé™
2. æŸ¥çœ‹åº”ç”¨æ—¥å¿—ä¸­çš„æƒé™æ‹’ç»ä¿¡æ¯
3. å°è¯•æå‡å®‰å…¨çº§åˆ«æˆ–æ·»åŠ è‡ªå®šä¹‰æƒé™

### é—®é¢˜ï¼šæ’ä»¶è¶…æ—¶

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥è¶…æ—¶é™åˆ¶è®¾ç½®ï¼ˆé»˜è®¤ 5 ç§’ï¼‰
2. è€ƒè™‘å¢åŠ è¶…æ—¶é™åˆ¶æˆ–ç¦ç”¨æ²™ç›’

### é—®é¢˜ï¼šå†…å­˜æº¢å‡º

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥å†…å­˜é™åˆ¶è®¾ç½®ï¼ˆé»˜è®¤ 100 MBï¼‰
2. ä¼˜åŒ–æ’ä»¶ä»£ç æˆ–å¢åŠ å†…å­˜é™åˆ¶

## æµ‹è¯•

è¿è¡Œæ²™ç›’ç³»ç»Ÿæµ‹è¯•ï¼š

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
cargo test --package ilauncher --lib plugin::sandbox::tests

# è¿è¡Œç‰¹å®šæµ‹è¯•
cargo test test_security_levels
cargo test test_permission_check
cargo test test_sandboxed_execution
cargo test test_timeout
```

## æœªæ¥æ”¹è¿›

1. **ç»†ç²’åº¦æ–‡ä»¶æƒé™**ï¼šæ”¯æŒå…·ä½“æ–‡ä»¶è·¯å¾„çš„è¯»å†™æƒé™
2. **ç½‘ç»œæµé‡ç›‘æ§**ï¼šç›‘æ§æ’ä»¶çš„ç½‘ç»œè¯·æ±‚
3. **èµ„æºä½¿ç”¨ç»Ÿè®¡**ï¼šæ˜¾ç¤ºæ’ä»¶çš„ CPU å’Œå†…å­˜ä½¿ç”¨
4. **æƒé™è¯·æ±‚ UI**ï¼šè¿è¡Œæ—¶åŠ¨æ€è¯·æ±‚æƒé™
5. **æ’ä»¶ç­¾åéªŒè¯**ï¼šéªŒè¯æ’ä»¶æ¥æºå’Œå®Œæ•´æ€§
6. **æ²™ç›’é€ƒé€¸æ£€æµ‹**ï¼šæ£€æµ‹æ½œåœ¨çš„æ²™ç›’ç»•è¿‡è¡Œä¸º

## è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ PR æ¥æ”¹è¿›æ²™ç›’ç³»ç»Ÿï¼

## è®¸å¯è¯

MIT License
