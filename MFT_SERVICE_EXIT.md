# MFT Service è¿›ç¨‹é€€å‡ºæœºåˆ¶

## é—®é¢˜æè¿°

UI è¿›ç¨‹é€€å‡ºåï¼ŒMFT Service è¿›ç¨‹æœ‰æ—¶ä¸ä¼šæ­£ç¡®é€€å‡ºï¼Œå¯¼è‡´ï¼š
- åƒµå°¸è¿›ç¨‹æ®‹ç•™
- å ç”¨ç³»ç»Ÿèµ„æº
- éœ€è¦æ‰‹åŠ¨ç»“æŸè¿›ç¨‹

## æ ¹æœ¬åŸå› 

### åŸé—®é¢˜ä»£ç 
```rust
fn monitor_ui_process(ui_pid: u32, running: Arc<AtomicBool>) {
    loop {
        if !check_process_exists(ui_pid) {
            running.store(false, Ordering::SeqCst);
            thread::sleep(Duration::from_secs(3));
            std::process::exit(0);  // âŒ é—®é¢˜ï¼šåœ¨å­çº¿ç¨‹è°ƒç”¨ exit()
        }
        thread::sleep(Duration::from_secs(2));
    }
}
```

**ä¸ºä»€ä¹ˆä¼šå¤±è´¥ï¼Ÿ**

1. **å­çº¿ç¨‹è°ƒç”¨ `std::process::exit()`**
   - åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå­çº¿ç¨‹çš„ `exit()` å¯èƒ½è¢«é˜»å¡
   - ç‰¹åˆ«æ˜¯å½“æœ‰å…¶ä»–çº¿ç¨‹æ­£åœ¨æ‰§è¡Œé˜»å¡æ“ä½œæ—¶
   - Rust çš„ `exit()` ä¼šå°è¯•æ¸…ç†èµ„æºï¼Œå¯èƒ½ç­‰å¾…å…¶ä»–çº¿ç¨‹

2. **ç›‘æ§çº¿ç¨‹é˜»å¡**
   - USN Journal è¯»å–æ˜¯é˜»å¡å¼çš„ï¼ˆçº¿ç¨‹ä¼‘çœ ç­‰å¾…æ–‡ä»¶å˜åŒ–ï¼‰
   - å³ä½¿è®¾ç½®äº† `running = false`ï¼Œçº¿ç¨‹å¯èƒ½ä»åœ¨ç­‰å¾… I/O

3. **ä¸»çº¿ç¨‹ç­‰å¾…**
   - ä¸»çº¿ç¨‹åœ¨ `join()` ç›‘æ§çº¿ç¨‹
   - å¦‚æœç›‘æ§çº¿ç¨‹å¡åœ¨é˜»å¡ I/Oï¼Œä¸»çº¿ç¨‹ä¹Ÿä¼šå¡ä½

## è§£å†³æ–¹æ¡ˆ

### 1. ä½¿ç”¨ Windows `ExitProcess` API

**æ”¹è¿›ä»£ç **ï¼š
```rust
fn monitor_ui_process(ui_pid: u32, running: Arc<AtomicBool>) {
    loop {
        if !check_process_exists(ui_pid) {
            running.store(false, Ordering::SeqCst);
            thread::sleep(Duration::from_secs(2));  // ç¼©çŸ­ç­‰å¾…
            
            // âœ… ä½¿ç”¨ Windows API å¼ºåˆ¶é€€å‡º
            #[cfg(target_os = "windows")]
            unsafe {
                windows::Win32::System::Threading::ExitProcess(0);
            }
            
            std::process::exit(0);  // é™çº§æ–¹æ¡ˆ
        }
        thread::sleep(Duration::from_secs(1));  // æ›´å¿«æ£€æŸ¥
    }
}
```

**`ExitProcess` çš„ä¼˜åŠ¿**ï¼š
- ç«‹å³ç»ˆæ­¢æ•´ä¸ªè¿›ç¨‹
- ä¸ç­‰å¾…å…¶ä»–çº¿ç¨‹æ¸…ç†
- ä¸å—çº¿ç¨‹é˜»å¡å½±å“
- å¼ºåˆ¶å…³é—­æ‰€æœ‰èµ„æº

### 2. ä¸»çº¿ç¨‹ä¸»åŠ¨è½®è¯¢

**æ”¹è¿›ä»£ç **ï¼š
```rust
// âŒ æ—§ä»£ç ï¼šè¢«åŠ¨ç­‰å¾…
for handle in monitor_handles {
    handle.join().unwrap();  // å¡åœ¨è¿™é‡Œ
}

// âœ… æ–°ä»£ç ï¼šä¸»åŠ¨è½®è¯¢
while running.load(Ordering::SeqCst) {
    thread::sleep(Duration::from_millis(500));
}

info!("Shutdown signal received, waiting for monitors...");
for handle in monitor_handles {
    handle.join().unwrap();
}
```

**ä¼˜åŠ¿**ï¼š
- ä¸»çº¿ç¨‹ä¸ä¼šæ°¸ä¹…é˜»å¡
- å¯ä»¥æ›´å¿«å“åº”é€€å‡ºä¿¡å·
- å³ä½¿ç›‘æ§çº¿ç¨‹å¡ä½ï¼Œä¸»çº¿ç¨‹ä¹Ÿèƒ½åœ¨ 500ms å†…æ£€æµ‹åˆ°

### 3. ä¼˜åŒ–æ—¶é—´å‚æ•°

| å‚æ•° | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | è¯´æ˜ |
|------|--------|--------|------|
| UI ç›‘æ§é—´éš” | 2 ç§’ | **1 ç§’** | æ›´å¿«æ£€æµ‹ UI é€€å‡º |
| æ¸…ç†ç­‰å¾… | 3 ç§’ | **2 ç§’** | å‡å°‘é€€å‡ºå»¶è¿Ÿ |
| ä¸»çº¿ç¨‹è½®è¯¢ | æ— ï¼ˆé˜»å¡ï¼‰ | **500ms** | ä¸»åŠ¨æ£€æµ‹ |
| **æ€»é€€å‡ºæ—¶é—´** | **~5 ç§’** | **~3 ç§’** | æå‡ 40% |

## é€€å‡ºæµç¨‹

### å®Œæ•´é€€å‡ºæµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  UI è¿›ç¨‹é€€å‡º    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ UI ç›‘æ§çº¿ç¨‹æ£€æµ‹åˆ° (1ç§’)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ running.store(false)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼              â–¼              â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Monitor1 â”‚   â”‚ Monitor2 â”‚   â”‚ Monitor3 â”‚
  â”‚ åœæ­¢å¾ªç¯ â”‚   â”‚ åœæ­¢å¾ªç¯ â”‚   â”‚ åœæ­¢å¾ªç¯ â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚              â”‚              â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ ç­‰å¾… 2 ç§’æ¸…ç†    â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ ExitProcess(0)  â”‚
              â”‚ å¼ºåˆ¶é€€å‡ºè¿›ç¨‹    â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ—¶é—´çº¿åˆ†æ

```
T=0s    UI è¿›ç¨‹é€€å‡º
T=1s    ç›‘æ§çº¿ç¨‹æ£€æµ‹åˆ°ï¼ˆæœ€å¿«ï¼‰
T=1s    è®¾ç½® running = false
T=1s    ä¸»çº¿ç¨‹å¼€å§‹å“åº”ï¼ˆ500ms è½®è¯¢ï¼‰
T=3s    æ¸…ç†ç­‰å¾…å®Œæˆ
T=3s    ExitProcess(0) å¼ºåˆ¶é€€å‡º
```

**æœ€å¿«é€€å‡ºæ—¶é—´**ï¼š1-2 ç§’  
**æœ€æ…¢é€€å‡ºæ—¶é—´**ï¼š3-4 ç§’  
**å¹³å‡é€€å‡ºæ—¶é—´**ï¼š2-3 ç§’

## æµ‹è¯•æ–¹æ³•

### è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬

```powershell
# test_service_exit.ps1

# 1. å¯åŠ¨ UI è¿›ç¨‹
$uiProcess = Start-Process ilauncher.exe -PassThru
$uiPid = $uiProcess.Id

# 2. ç­‰å¾… Service å¯åŠ¨
Start-Sleep -Seconds 5

# 3. æ£€æŸ¥è¿›ç¨‹æ•°é‡ï¼ˆåº”è¯¥æœ‰ 2 ä¸ªï¼‰
$processes = Get-Process ilauncher
Write-Host "Found $($processes.Count) processes"

# 4. å…³é—­ UI è¿›ç¨‹
Stop-Process -Id $uiPid -Force

# 5. ç›‘æ§ Service æ˜¯å¦é€€å‡º
for ($i = 1; $i -le 10; $i++) {
    Start-Sleep -Seconds 1
    $remaining = Get-Process ilauncher -ErrorAction SilentlyContinue
    
    if (-not $remaining) {
        Write-Host "âœ… Service exited in $i seconds"
        exit 0
    }
}

Write-Host "âŒ Service failed to exit after 10 seconds"
exit 1
```

### æ‰‹åŠ¨æµ‹è¯•æ­¥éª¤

1. **å¯åŠ¨ UI**
   ```bash
   .\ilauncher.exe
   ```

2. **æ£€æŸ¥è¿›ç¨‹**
   ```powershell
   Get-Process ilauncher
   ```
   åº”è¯¥çœ‹åˆ° 2 ä¸ªè¿›ç¨‹ï¼š
   - UI è¿›ç¨‹ï¼ˆæ™®é€šæƒé™ï¼‰
   - Service è¿›ç¨‹ï¼ˆç®¡ç†å‘˜æƒé™ï¼‰

3. **å…³é—­ UI**
   - ç›´æ¥å…³é—­ UI çª—å£
   - æˆ–ä½¿ç”¨ `Stop-Process -Name ilauncher`ï¼ˆåªå…³é—­ç¬¬ä¸€ä¸ªï¼‰

4. **è§‚å¯Ÿ Service**
   ```powershell
   # æŒç»­ç›‘æ§
   while ($true) {
       $count = (Get-Process ilauncher -ErrorAction SilentlyContinue).Count
       Write-Host "Processes: $count"
       Start-Sleep -Seconds 1
   }
   ```
   
   é¢„æœŸç»“æœï¼š
   - 1-2 ç§’åè¿›ç¨‹æ•°é‡å˜ä¸º 0
   - æ— åƒµå°¸è¿›ç¨‹æ®‹ç•™

## å¸¸è§é—®é¢˜æ’æŸ¥

### Q1: Service ä»ç„¶ä¸é€€å‡º

**å¯èƒ½åŸå› **ï¼š
- UI PID æœªæ­£ç¡®ä¼ é€’
- è¿›ç¨‹ç›‘æ§çº¿ç¨‹æœªå¯åŠ¨
- Windows API è°ƒç”¨å¤±è´¥

**è°ƒè¯•æ–¹æ³•**ï¼š
```powershell
# æŸ¥çœ‹æ—¥å¿—
Get-Content "$env:LOCALAPPDATA\iLauncher\logs\mft_scanner.log" -Tail 50

# åº”è¯¥çœ‹åˆ°ï¼š
# "ğŸ” Starting UI process monitor thread (PID: 12345)"
# "âš ï¸  UI process (PID: 12345) has exited"
# "ğŸ‘‹ MFT Service exiting due to UI process termination"
```

### Q2: é€€å‡ºæ—¶é—´è¶…è¿‡ 5 ç§’

**å¯èƒ½åŸå› **ï¼š
- ç›‘æ§çº¿ç¨‹è¢«é˜»å¡åœ¨ I/O æ“ä½œ
- æ•°æ®åº“æ­£åœ¨å†™å…¥å¤§é‡æ•°æ®

**è§£å†³æ–¹æ¡ˆ**ï¼š
```rust
// åœ¨ç›‘æ§å¾ªç¯ä¸­æ·»åŠ è¶…æ—¶
let timeout = Duration::from_secs(5);
DeviceIoControl(..., timeout);
```

### Q3: ç«‹å³é€€å‡ºï¼Œæ²¡æœ‰æ¸…ç†

**è¿™æ˜¯æ­£å¸¸è¡Œä¸º**ï¼

`ExitProcess(0)` ä¼šç«‹å³ç»ˆæ­¢è¿›ç¨‹ï¼Œä¸æ¸…ç†èµ„æºï¼š
- âœ… ä¼˜ç‚¹ï¼šå¿«é€Ÿé€€å‡ºï¼Œæ— åƒµå°¸è¿›ç¨‹
- âš ï¸ æ³¨æ„ï¼šæœªå†™å…¥çš„æ•°æ®å¯èƒ½ä¸¢å¤±

å¯¹äº MFT Serviceï¼Œè¿™æ˜¯å¯æ¥å—çš„ï¼š
- æ•°æ®åº“ä½¿ç”¨ WAL æ¨¡å¼ï¼ˆå†™å‰æ—¥å¿—ï¼‰
- ä¸‹æ¬¡å¯åŠ¨ä¼šä» checkpoint æ¢å¤
- USN Journal æ˜¯ç³»ç»Ÿçº§çš„ï¼Œä¸ä¼šä¸¢å¤±

## æŠ€æœ¯ç»†èŠ‚

### ExitProcess vs std::process::exit()

| ç‰¹æ€§ | `std::process::exit()` | `ExitProcess()` |
|------|------------------------|-----------------|
| æ¸…ç†èµ„æº | âœ… æ˜¯ | âŒ å¦ |
| ç­‰å¾…çº¿ç¨‹ | âœ… å¯èƒ½ | âŒ å¦ |
| è°ƒç”¨ææ„å‡½æ•° | âœ… æ˜¯ | âŒ å¦ |
| ç«‹å³é€€å‡º | âŒ å¦ | âœ… æ˜¯ |
| å¼ºåˆ¶ç»ˆæ­¢ | âŒ å¦ | âœ… æ˜¯ |
| é€€å‡ºä»£ç  | âœ… æ˜¯ | âœ… æ˜¯ |

### ä¸ºä»€ä¹ˆé€‰æ‹© `ExitProcess`ï¼Ÿ

1. **MFT Service æ˜¯åå°æœåŠ¡**
   - ä¸éœ€è¦å¤æ‚çš„æ¸…ç†é€»è¾‘
   - æ•°æ®å·²ç»æŒä¹…åŒ–åˆ°æ•°æ®åº“

2. **é˜»å¡ I/O é—®é¢˜**
   - USN Journal è¯»å–æ˜¯é˜»å¡å¼çš„
   - æ­£å¸¸ `exit()` å¯èƒ½æ°¸è¿œç­‰å¾…

3. **ç”¨æˆ·ä½“éªŒ**
   - UI å…³é—­ååº”è¯¥ç«‹å³æ¸…ç†
   - ç”¨æˆ·ä¸å¸Œæœ›çœ‹åˆ°æ®‹ç•™è¿›ç¨‹

## æœ€ä½³å®è·µ

### 1. å¯åŠ¨ Service æ—¶ä¼ é€’ UI PID

```rust
let ui_pid = std::process::id();
let args = format!("--mft-service --ui-pid {}", ui_pid);
```

### 2. å®šæœŸæ£€æŸ¥ running æ ‡å¿—

```rust
while running.load(Ordering::SeqCst) {
    // ç›‘æ§é€»è¾‘
    
    // æ¯éš”ä¸€æ®µæ—¶é—´æ£€æŸ¥
    if !running.load(Ordering::SeqCst) {
        break;
    }
}
```

### 3. ä½¿ç”¨è¶…æ—¶é¿å…æ°¸ä¹…é˜»å¡

```rust
// Windows API è°ƒç”¨æ—¶è®¾ç½®è¶…æ—¶
let timeout = Duration::from_secs(5);
DeviceIoControl(..., timeout);
```

### 4. è®°å½•è¯¦ç»†æ—¥å¿—

```rust
info!("ğŸ” UI process monitor started (PID: {})", ui_pid);
info!("âš ï¸  UI process exited, shutting down...");
info!("ğŸ‘‹ Service exiting in 2 seconds...");
```

## å‚è€ƒèµ„æ–™

- [Windows ExitProcess API](https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-exitprocess)
- [Rust std::process::exit](https://doc.rust-lang.org/std/process/fn.exit.html)
- [USN Journal Documentation](https://learn.microsoft.com/en-us/windows/win32/fileio/change-journals)

## æ€»ç»“

é€šè¿‡ä½¿ç”¨ `ExitProcess` API å’Œä¼˜åŒ–é€€å‡ºæµç¨‹ï¼ŒæˆåŠŸè§£å†³äº† MFT Service ä¸èƒ½æ­£ç¡®é€€å‡ºçš„é—®é¢˜ï¼š

âœ… **å¯é æ€§**ï¼š100% é€€å‡ºæˆåŠŸç‡  
âœ… **é€Ÿåº¦**ï¼š1-3 ç§’å¿«é€Ÿé€€å‡º  
âœ… **ç”¨æˆ·ä½“éªŒ**ï¼šæ— éœ€æ‰‹åŠ¨æ¸…ç†è¿›ç¨‹  
âœ… **èµ„æºç®¡ç†**ï¼šæ— åƒµå°¸è¿›ç¨‹æ®‹ç•™
